generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Chapter {
  id                     String    @id
  projectId              String
  outlineId              String?
  chapterNumber          Int
  title                  String
  content                String
  wordCount              Int       @default(0)
  status                 String    @default("pending")
  aiModel                String?
  generatedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime
  keyNumbers             Json?
  keyPoints              String[]  @default([])
  newCharacters          String[]  @default([])
  newTerms               Json?
  summary                String?
  systemPrompt           String?
  userPrompt             String?
  lastModifiedBy         String?   @default("system")
  previousContent        String?
  previousContentSavedAt DateTime?
  Outline                Outline?  @relation(fields: [outlineId], references: [id])
  Project                Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, chapterNumber])
  @@index([projectId])
  @@index([status])
}

model ConsistencyReport {
  id           String   @id
  projectId    String
  report       Json
  overallScore Int
  createdAt    DateTime @default(now())
  Project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([projectId])
}

model ExportedBook {
  id             String   @id
  projectId      String
  title          String
  fileName       String
  fileUrl        String
  fileSizeBytes  Int
  format         String   @default("pdf")
  version        Int      @default(1)
  chaptersCount  Int
  totalWords     Int
  totalPages     Int
  status         String   @default("ready")
  errorMessage   String?
  generatedAt    DateTime @default(now())
  lastAccessedAt DateTime @default(now())
  Project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([generatedAt])
  @@index([lastAccessedAt])
  @@index([projectId])
  @@index([status])
}

model GenerationLog {
  id               String   @id
  projectId        String
  step             String
  aiModel          String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  cost             Float?
  duration         Int
  success          Boolean
  errorMessage     String?
  createdAt        DateTime @default(now())
  Project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([projectId])
  @@index([success])
}

model Outline {
  id             String    @id
  projectId      String    @unique
  structure      Json
  totalChapters  Int
  estimatedWords Int
  aiModel        String
  generatedAt    DateTime  @default(now())
  Chapter        Chapter[]
  Project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Project {
  id                  String              @id
  userId              String
  authorName          String
  authorRole          String
  company             String
  industry            String
  bookTitle           String
  bookSubtitle        String?
  targetReaders       String
  currentSituation    String
  challengeFaced      String
  transformation      String
  achievement         String
  lessonLearned       String
  businessGoals       String
  uniqueValue         String
  estimatedPages      Int?
  additionalNotes     String?
  status              String              @default("draft")
  generationProgress  Json?               @default("{\"status\": \"idle\", \"progress\": 0, \"chaptersTotal\": 0, \"chaptersComplete\": 0}")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  masterContext       Json?
  styleGuide          Json?
  customStyleGuide    String?
  generatedStyleGuide String?
  styleGuideCreatedAt DateTime?
  styleGuideSource    String?
  Chapter             Chapter[]
  ConsistencyReport   ConsistencyReport[]
  ExportedBook        ExportedBook[]
  GenerationLog       GenerationLog[]
  Outline             Outline?
  User                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  ProjectAIConfig     ProjectAIConfig?
  ProjectDocument     ProjectDocument[]

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model ProjectAIConfig {
  id                        String    @id
  projectId                 String    @unique
  targetWordsPerChapter     Int       @default(5000)
  model                     String    @default("gpt-5-mini")
  temperature               Float?    @default(0.7)
  maxTokens                 Int       @default(20000)
  topP                      Float?    @default(0.95)
  frequencyPenalty          Float?    @default(0.3)
  presencePenalty           Float?    @default(0.3)
  useCustomPrompts          Boolean   @default(false)
  customSystemPrompt        String?
  customOutlineInstructions String?
  customChapterInstructions String?
  lastTestAt                DateTime?
  testOutput                String?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime
  reasoningEffort           String    @default("low")
  verbosity                 String    @default("medium")
  Project                   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectDocument {
  id                String   @id
  projectId         String
  originalFileName  String
  fileType          String
  fileSizeBytes     Int
  extractedText     String
  wordCount         Int
  purpose           String   @default("style_reference")
  usedForStyleGuide Boolean  @default(false)
  usedInChapters    Int[]    @default([])
  processingStatus  String   @default("completed")
  errorMessage      String?
  uploadedAt        DateTime @default(now())
  Project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([processingStatus])
  @@index([projectId])
  @@index([purpose])
}

model User {
  id        String    @id
  email     String    @unique
  name      String
  role      String    @default("ghost_writer")
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Project   Project[]

  @@index([email])
}
